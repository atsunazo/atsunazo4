<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no",interactive-widget=resizes-content>
    <title>謎解き3</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
        }
        #title-image {
            width: 100%;
            max-width: 100%;
            height: auto;
            margin-bottom: 15px;
            margin-top: 30px
        }
        #quiz-screen, #finish-screen {
            display: none;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
        }
        .rank {
            font-size: 24px;
            font-weight: bold;
        }
        #question-image {
            max-width: 100%;
            height: auto;
            margin-bottom: 20px;
        }
        .time-warning {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        function MainComponent() {
            const [gameState, setGameState] = React.useState('start');
            const [playerName, setPlayerName] = React.useState('');
            const [currentQuestion, setCurrentQuestion] = React.useState(0);
            const [answers, setAnswers] = React.useState([]);
            const [solvedQuestions, setSolvedQuestions] = React.useState(new Set());
            const [remainingTime, setRemainingTime] = React.useState(40);
            const [resultMessage, setResultMessage] = React.useState('');

            const QUESTION_TIME_LIMIT = 40;

            const questions = [
                { image: './1.png', answer: ['れい', 'レイ','零','礼'] },
                { image: './2.png', answer: ['いちみ', 'イチミ','一味'] },
                { image: './3.png', answer: ['にばしゃ', 'ニバシャ','荷馬車'] },
                { image: './4.png', answer: ['サングラス', 'さんぐらす'] },
                { image: './5.png', answer: ['しるくはっと', 'シルクハット'] },
                { image: './6.png', answer: ['ゴールキーパー', 'ごーるきーぱー'] },
                { image: './7.png', answer: ['ろくはらたんだい', 'ロクハラタンダイ','六波羅探題'] },
            ];

            const hiraganaGrid = [
                ["あ", "い", "う", "え", "お"],
                ["か", "き", "く", "け", "こ"],
                ["さ", "し", "す", "せ", "そ"],
                ["た", "ち", "つ", "て", "と"],
                ["な", "に", "ぬ", "ね", "の"],
                ["は", "ひ", "ふ", "へ", "ほ"],
                ["ま", "み", "む", "め", "も"],
                ["や", "", "ゆ", "", "よ"],
                ["ら", "り", "る", "れ", "ろ"],
                ["わ", "", "", "", "を"],
                ["ん", "゛", "゜", "小", "×"]
            ];

            const dakutenMap = {
                か: "が", き: "ぎ", く: "ぐ", け: "げ", こ: "ご",
                さ: "ざ", し: "じ", す: "ず", せ: "ぜ", そ: "ぞ",
                た: "だ", ち: "ぢ", つ: "づ", て: "で", と: "ど",
                は: "ば", ひ: "び", ふ: "ぶ", へ: "べ", ほ: "ぼ",
                が: "か", ぎ: "き", ぐ: "く", げ: "け", ご: "こ",
                ざ: "さ", じ: "し", ず: "す", ぜ: "せ", ぞ: "そ",
                だ: "た", ぢ: "ち", づ: "つ", で: "て", ど: "と",
                ば: "は", び: "ひ", ぶ: "ふ", べ: "へ", ぼ: "ほ",
                ぱ: "ば", ぴ: "び", ぷ: "ぶ", ぺ: "べ", ぽ: "ぼ"
            };

            const handakutenMap = {
                は: "ぱ", ひ: "ぴ", ふ: "ぷ", へ: "ぺ", ほ: "ぽ",
                ば: "ぱ", び: "ぴ", ぶ: "ぷ", べ: "ぺ", ぼ: "ぽ",
                ぱ: "ば", ぴ: "び", ぷ: "ぶ", ぺ: "べ", ぽ: "ぼ"
            };

            const smallMap = {
                つ: "っ", や: "ゃ", ゆ: "ゅ", よ: "ょ",
                あ: "ぁ", い: "ぃ", う: "ぅ", え: "ぇ", お: "ぉ",
                っ: "つ", ゃ: "や", ゅ: "ゆ", ょ: "よ",
                ぁ: "あ", ぃ: "い", ぅ: "う", ぇ: "え", ぉ: "お"
            };

            const handleCharacterClick = (char) => {
                if (char === "×") {
                    setAnswers(prev => [...prev.slice(0, -1)]);
                    return;
                }

                if (char === "゛" || char === "゜" || char === "小") {
                    const lastChar = answers[answers.length - 1];
                    if (char === "゛" && dakutenMap[lastChar]) {
                        setAnswers(prev => [...prev.slice(0, -1), dakutenMap[lastChar]]);
                    } else if (char === "゜" && handakutenMap[lastChar]) {
                        setAnswers(prev => [...prev.slice(0, -1), handakutenMap[lastChar]]);
                    } else if (char === "小" && smallMap[lastChar]) {
                        setAnswers(prev => [...prev.slice(0, -1), smallMap[lastChar]]);
                    }
                    return;
                }

                if (char !== "") {
                    setAnswers(prev => [...prev, char]);
                }
            };

            const handleSubmit = () => {
                const userAnswer = answers.join('');
                if (questions[currentQuestion].answer.includes(userAnswer)) {
                    setSolvedQuestions(prev => new Set(prev).add(currentQuestion));
                    setResultMessage('せいかい');
                    setTimeout(() => {
                        if (currentQuestion < questions.length - 1) {
                            setCurrentQuestion(currentQuestion + 1);
                            setAnswers([]);
                            setResultMessage('');
                            setRemainingTime(QUESTION_TIME_LIMIT);
                        } else {
                            setGameState('finish');
                        }
                    }, 1000);
                } else {
                    setResultMessage('ちがうよ');
                }
            };

            React.useEffect(() => {
                if (gameState === 'quiz') {
                    const timer = setInterval(() => {
                        setRemainingTime(prev => {
                            if (prev <= 1) {
                                clearInterval(timer);
                                if (currentQuestion < questions.length - 1) {
                                    setCurrentQuestion(currentQuestion + 1);
                                    setAnswers([]);
                                    setResultMessage('');
                                    return QUESTION_TIME_LIMIT;
                                } else {
                                    setGameState('finish');
                                    return 0;
                                }
                            }
                            return prev - 1;
                        });
                    }, 1000);
                    return () => clearInterval(timer);
                }
            }, [gameState, currentQuestion]);

            const startQuiz = () => {
                setGameState('quiz');
                setRemainingTime(QUESTION_TIME_LIMIT);
            };

            const getRank = (solvedCount) => {
                const percentage = (solvedCount / questions.length) * 100;
                if (percentage >= 100) return 'SS';
                if (percentage >= 80) return 'S';
                if (percentage >= 60) return 'A';
                if (percentage >= 40) return 'B';
                return 'C';
            };

            if (gameState === 'start') {
                return (
                    <div className="min-h-screen bg-white dark:bg-gray-900 p-4 flex flex-col items-center">
                        <h1 className="text-2xl font-bold mb-4">なないろレインボー</h1>
                        <img id="title-image" src="./0.png" alt="タイトル画像" className="mb-4" />
                        <input
                            type="text"
                            value={playerName}
                            onChange={(e) => setPlayerName(e.target.value)}
                            placeholder="名前を入力してください"
                            className="mb-4 p-2 border rounded"
                        />
                        <button onClick={startQuiz} className="bg-blue-500 text-white p-2 rounded">開始</button>
                    </div>
                );
            }

            if (gameState === 'quiz') {
                return (
                    <div className="min-h-screen bg-white dark:bg-gray-900 p-4 flex flex-col items-center">
                        <img src={questions[currentQuestion].image} alt="問題画像" className="mb-4 max-w-full" />
                        <div className="mb-4">{answers.join('')}</div>
                        <div className="mb-4">
                            <button onClick={handleSubmit} className="bg-green-500 text-white p-2 rounded mr-2">判定</button>
                            <span className={`ml-2 ${remainingTime <= 10 ? 'text-red-500' : ''}`}>残り時間: {remainingTime}秒</span>
                        </div>
                        <div className={`mb-4 ${resultMessage === 'せいかい' ? 'text-green-500' : 'text-red-500'}`}>{resultMessage}</div>
                        <div className="w-full flex justify-center">
                            <div className="w-full flex justify-end">
                                <div className="flex flex-row-reverse gap-[3px]" style={{ width: 'calc(100% - 1px)' }}>
                                    {hiraganaGrid.map((row, rowIndex) => (
                                        <div key={rowIndex} className="flex flex-col gap-[3px] flex-1">
                                            {row.map((char) => (
                                                <button
                                                    key={char}
                                                    onClick={() => handleCharacterClick(char)}
                                                    className={`w-full aspect-square text-sm rounded-md border font-inter ${
                                                        char === ""
                                                            ? "invisible"
                                                            : char === "×"
                                                            ? "bg-red-50 hover:bg-red-100 text-red-600 border-red-200 dark:bg-red-900/20 dark:hover:bg-red-900/30 dark:text-red-400 dark:border-red-800"
                                                            : ["゛", "゜", "小"].includes(char)
                                                            ? "bg-blue-50 hover:bg-blue-100 text-blue-600 border-blue-200 dark:bg-blue-900/20 dark:hover:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800"
                                                            : "border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-800"
                                                    }`}
                                                >
                                                    {char}
                                                </button>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'finish') {
                const solvedCount = solvedQuestions.size;
                return (
                    <div className="min-h-screen bg-white dark:bg-gray-900 p-4 flex flex-col items-center">
                        <h2 className="text-2xl font-bold mb-4">終了</h2>
                        <p>名前: {playerName || 'ななし'}</p>
                        <p>正解数: {solvedCount}/{questions.length}</p>
                        <p className="text-2xl font-bold">ランク: {getRank(solvedCount)}</p>
                    </div>
                );
            }
        }

        ReactDOM.render(<MainComponent />, document.getElementById('root'));
    </script>
</body>
</html>
